<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Size Me</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      .pulse {
        animation: pulseAnim 0.5s ease;
      }
      @keyframes pulseAnim {
        0% { transform: scale(1); }
        50% { transform: scale(1.08); }
        100% { transform: scale(1); }
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

  <script type="text/babel" data-presets="react">
  const { useState, useMemo } = React;

  // --- Size Chart Data (same as before) ---
  const SIZE_CHARTS = {
    Nike:{Tops:{Men:[
      {label:"S", chest:[86,94], waist:[73,81], hips:[86,94]},
      {label:"M", chest:[94,102], waist:[81,89], hips:[94,102]},
      {label:"L", chest:[102,110], waist:[89,97], hips:[102,110]}
    ],Women:[
      {label:"S", chest:[83,90], waist:[67,74], hips:[90,96]},
      {label:"M", chest:[90,97], waist:[74,81], hips:[96,103]},
      {label:"L", chest:[97,104], waist:[81,88], hips:[103,110]}
    ]},Bottoms:{Men:[
      {label:"30", waist:[74,78], hips:[89,92], inseam:[76,84]},
      {label:"32", waist:[79,83], hips:[93,96], inseam:[76,86]},
      {label:"34", waist:[84,88], hips:[97,100], inseam:[76,86]}
    ],Women:[
      {label:"4-6", waist:[67,74], hips:[90,96], inseam:[74,84]},
      {label:"8-10", waist:[74,81], hips:[96,103], inseam:[74,86]}
    ]}},
    Adidas:{Tops:{Men:[
      {label:"S", chest:[88,94], waist:[76,82], hips:[88,94]},
      {label:"M", chest:[95,102], waist:[83,90], hips:[95,102]},
      {label:"L", chest:[103,111], waist:[91,99], hips:[103,111]}
    ],Women:[
      {label:"S", chest:[83,88], waist:[67,72], hips:[90,95]},
      {label:"M", chest:[89,94], waist:[73,78], hips:[96,101]}
    ]},Bottoms:{Men:[
      {label:"M (32)", waist:[81,86], hips:[95,101], inseam:[76,86]},
      {label:"L (34)", waist:[87,93], hips:[102,108], inseam:[76,86]}
    ],Women:[
      {label:"M (8-10)", waist:[73,79], hips:[96,102], inseam:[74,86]}
    ]}},
    Uniqlo:{Tops:{Men:[
      {label:"S", chest:[86,92], waist:[74,80], hips:[88,94]},
      {label:"M", chest:[92,98], waist:[80,86], hips:[94,100]},
      {label:"L", chest:[98,104], waist:[86,92], hips:[100,106]}
    ],Women:[
      {label:"S", chest:[80,86], waist:[64,70], hips:[88,94]},
      {label:"M", chest:[86,92], waist:[70,76], hips:[94,100]}
    ]},Bottoms:{Men:[
      {label:"30", waist:[74,78], hips:[90,94], inseam:[74,86]},
      {label:"32", waist:[79,83], hips:[95,99], inseam:[74,86]}
    ],Women:[
      {label:"25-26", waist:[61,64], hips:[86,90], inseam:[72,82]},
      {label:"27-28", waist:[65,70], hips:[90,95], inseam:[72,84]}
    ]}}
  };

  const ALL_BRANDS = Object.keys(SIZE_CHARTS);
  const CATEGORIES = ["Tops","Bottoms"];
  const GENDERS = ["Men","Women"];

  // --- Helpers ---
  const cmToIn = (cm)=> cm/2.54;
  const inToCm = (inch)=> inch*2.54;
  const clamp = (n,a,b)=> Math.max(a,Math.min(b,n));
  const within = ([lo,hi],v,pad=0)=> v>=lo-pad && v<=hi+pad;

  // distance outside a range (in cm). 0 means inside.
  function distToRange([lo, hi], v, pad=0) {
    const L = lo - pad, H = hi + pad;
    if (v < L) return L - v;
    if (v > H) return v - H;
    return 0;
  }

  function scoreSize(row, measCm, category, padCm){
    const keys = category==='Tops' ? ['chest','waist','hips'] : ['waist','hips','inseam'];
    let score=0, used=0;
    for(const k of keys){
      if(!row[k] || !measCm[k]) continue;
      used++;
      const d = distToRange(row[k], measCm[k], padCm);
      score += d===0 ? 2 : 1 - d/10; // inside gets 2, otherwise fall off by 0.1 per cm
    }
    return used ? score/used : -Infinity;
  }

  function pickByRules(chart, measCm, category, padCm, strict){
  if(!Array.isArray(chart) || chart.length===0) return null;
  const keys = category==='Tops' ? ['chest','waist','hips'] : ['waist','hips','inseam'];

  // A) Strict in-range first (all relevant measurements inside range with tolerance)
  if (strict) {
    for (const row of chart) {
      const ok = keys.every(k => !row[k] || distToRange(row[k], (measCm[k]||0), padCm) === 0);
      if (ok) return { row, reason: 'strict_in_range' };
    }
  }

  // B) Otherwise: pick the smallest size that is NOT TOO SMALL
  //    (i.e., none of the measurements exceed that size's upper bound + tol)
  for (const row of chart) {
    const notTooSmall = keys.every(k => !row[k] || (measCm[k]==null ? true : (measCm[k] <= row[k][1] + padCm)));
    if (notTooSmall) return { row, reason: 'sized_up_to_fit' };
  }

  // C) If all sizes are too small, choose the largest and mark as over max
  return { row: chart[chart.length - 1], reason: 'over_max' };
}


  function prettyRange([lo,hi], unit){
    const f = unit==='in' ? cmToIn : (x)=>x;
    const a = Math.round(f(lo)*10)/10, b = Math.round(f(hi)*10)/10;
    return a + "â€“" + b + " " + unit;
  }

  function prettyDelta(deltaCm, unit){
    const v = unit==='in' ? cmToIn(deltaCm) : deltaCm;
    const n = Math.round(v*10)/10;
    return (n===0 ? "in range" : (n>0 ? ("+"+n) : n) + " " + unit);
  }

  function App(){
    const [unit, setUnit] = useState('cm');
    const [category, setCategory] = useState('Tops');
    const [gender, setGender] = useState('Men');
    const [brands, setBrands] = useState(ALL_BRANDS);
    const [meas, setMeas] = useState({ chest:100, waist:84, hips:100, inseam:80, height:178 });
    const [tolerance, setTolerance] = useState(1.5); // cm wiggle room
    const [strict, setStrict] = useState(false);     // require all measurements in range
    const [calcTick, setCalcTick] = useState(0);
    const [showToast, setShowToast] = useState(false);
    const [btnPulse, setBtnPulse] = useState(false);

    const measCm = useMemo(()=> unit==='cm' ? meas : ({
      chest: inToCm(meas.chest||0),
      waist: inToCm(meas.waist||0),
      hips: inToCm(meas.hips||0),
      inseam: inToCm(meas.inseam||0),
      height: inToCm(meas.height||0),
    }), [meas, unit]);

    // Compute picks per brand, plus diagnostics
    const results = useMemo(()=>{
      const out = {};
      for(const b of brands){
        const chart = SIZE_CHARTS[b] && SIZE_CHARTS[b][category] && SIZE_CHARTS[b][category][gender];
        if(!chart) continue;

        // If strict: filter to rows where ALL relevant measurements are in range (with tol)
        const keys = category==='Tops' ? ['chest','waist','hips'] : ['waist','hips','inseam'];
        let candidates = chart;
        if(strict){
          candidates = chart.filter(row =>
            keys.every(k => !row[k] || distToRange(row[k], measCm[k]||0, tolerance)===0)
          );
        }

        const pick = pickBest(candidates.length? candidates : chart, measCm, category, tolerance);
        if(!pick) continue;

        // diagnostics: per-measure delta (cm outside range)
        const diag = {};
        for(const k of keys){
          if(!pick[k] || !measCm[k]) continue;
          const d = distToRange(pick[k], measCm[k], tolerance); // cm
          diag[k] = d;
        }

        out[b] = { pick, diag, strictUsed: strict, hadStrictCandidate: candidates.length>0 };
      }
      return out;
    }, [brands, category, gender, measCm, tolerance, strict, calcTick]);

    const unitLabel = unit==='cm' ? 'cm' : 'in';
    function handleNumChange(k,val){
      let v=parseFloat(val); if(Number.isNaN(v)) v=0; v=clamp(v,0,400);
      setMeas(m=>({...m,[k]:v}));
    }

    return (
      <div className="min-h-screen">
        <header className="sticky top-0 z-10 backdrop-blur bg-white/70 border-b">
          <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-8 h-8 rounded-full bg-slate-300 flex items-center justify-center text-sm font-bold">S</div>
              <h1 className="text-2xl font-semibold">Size Me</h1>
            </div>
            <div className="flex items-center gap-2 text-sm">
              <span className="mr-1">Units</span>
              <div className="inline-flex rounded-xl border overflow-hidden">
                <button className={"px-3 py-1 " + (unit==='cm'?'bg-slate-900 text-white':'bg-white')} onClick={()=>setUnit('cm')}>cm</button>
                <button className={"px-3 py-1 " + (unit==='in'?'bg-slate-900 text-white':'bg-white')} onClick={()=>setUnit('in')}>in</button>
              </div>
            </div>
          </div>
        </header>

        <main className="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
          <section className="bg-white rounded-2xl shadow p-5">
            <h2 className="text-lg font-semibold mb-4">Your measurements</h2>
            <div className="grid grid-cols-2 gap-4">
              {[
                ['chest','Chest'],
                ['waist','Waist'],
                ['hips','Hips'],
                ['inseam','Inseam'],
                ['height','Height'],
              ].map(([key,label])=>(
                <div key={key} className="flex flex-col">
                  <label className="text-sm text-slate-600 mb-1">{label} ({unitLabel})</label>
                  <input type="number" step="any" value={meas[key]} onChange={(e)=>handleNumChange(key, e.target.value)} className="rounded-xl border px-3 py-2" />
                </div>
              ))}
            </div>

            <div className="mt-6 grid grid-cols-2 gap-4">
              <div>
                <label className="text-sm text-slate-600 mb-1">Category</label>
                <select className="w-full rounded-xl border px-3 py-2" value={category} onChange={(e)=>setCategory(e.target.value)}>
                  {CATEGORIES.map(c=><option key={c} value={c}>{c}</option>)}
                </select>
              </div>
              <div>
                <label className="text-sm text-slate-600 mb-1">Fit</label>
                <select className="w-full rounded-xl border px-3 py-2" value={gender} onChange={(e)=>setGender(e.target.value)}>
                  {GENDERS.map(g=><option key={g} value={g}>{g}</option>)}
                </select>
              </div>
            </div>

            <div className="mt-6 grid grid-cols-2 gap-4 items-end">
              <div>
                <label className="text-sm text-slate-600 mb-1">Tolerance (cm)</label>
                <input type="number" min="0" max="5" step="0.5" value={tolerance} onChange={(e)=>setTolerance(clamp(parseFloat(e.target.value)||0,0,5))} className="rounded-xl border px-3 py-2 w-28" />
              </div>
              <label className="inline-flex items-center gap-2 mb-1">
                <input type="checkbox" checked={strict} onChange={(e)=>setStrict(e.target.checked)} />
                <span className="text-sm text-slate-700">Strict match (all measurements must be in range)</span>
              </label>
            </div>

            <div className="mt-6">
              <label className="text-sm text-slate-600 mb-2 block">Brands</label>
              <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                {ALL_BRANDS.map(b=>{
                  const checked = brands.includes(b);
                  return (
                    <label key={b} className={"flex items-center gap-2 rounded-xl border px-3 py-2 cursor-pointer " + (checked ? "bg-slate-900 text-white border-slate-900" : "bg-white")}>
                      <input className="hidden" type="checkbox" checked={checked} onChange={(e)=>{
                        setBrands(prev => e.target.checked ? Array.from(new Set(prev.concat([b]))) : prev.filter(x=>x!==b));
                      }} />
                      <span className="text-sm font-medium">{b}</span>
                    </label>
                  );
                })}
              </div>
            </div>

            <div className="mt-6 flex flex-wrap gap-3">
              <button
                className={"rounded-xl bg-slate-900 text-white px-4 py-2 shadow" + (btnPulse ? " pulse" : "")}
                onClick={() => {
                  setCalcTick(t => t + 1);
                  setShowToast(true);
                  setBtnPulse(true);
                  setTimeout(() => setShowToast(false), 1500);
                  setTimeout(() => setBtnPulse(false), 500);
                  document.getElementById('results')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }}
              >Calculate</button>
              <button className="rounded-xl border px-4 py-2" onClick={()=>{
                const preset = unit==='cm'
                  ? { chest:100, waist:84, hips:100, inseam:80, height:178 }
                  : { chest:39.4, waist:33.1, hips:39.4, inseam:31.5, height:70.1 };
                setMeas(preset);
              }}>Use sample</button>
              <button className="rounded-xl border px-4 py-2" onClick={()=>{
                const resOut = {};
                const measCmNow = unit==='cm' ? meas : { chest: inToCm(meas.chest||0), waist: inToCm(meas.waist||0), hips: inToCm(meas.hips||0), inseam: inToCm(meas.inseam||0), height: inToCm(meas.height||0) };
                for(const b of brands){
                  const chart = SIZE_CHARTS[b] && SIZE_CHARTS[b][category] && SIZE_CHARTS[b][category][gender];
                  const pick = pickBest(chart, measCmNow, category, tolerance);
                  if(pick) resOut[b]=pick;
                }
                const blob = new Blob([JSON.stringify({ input:{ unit, category, gender, meas, tolerance, strict }, results: resOut }, null, 2)], { type:"application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url; a.download = "size-me-results.json"; a.click();
                URL.revokeObjectURL(url);
              }}>Export results (JSON)</button>
            </div>

            <p className="mt-4 text-xs text-slate-500">Prototype only. Ranges are approximate and may vary by style or fabric. Use tolerance to reflect preferred fit.</p>
          </section>

          <section id="results" className="bg-white rounded-2xl shadow p-5">
            <h2 className="text-lg font-semibold mb-4">Recommended sizes</h2>
            <ResultsPanel unit={unit} results={results} category={category} tolerance={tolerance} />
          </section>
        </main>

        {showToast && (<div className="fixed bottom-6 right-6 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg">Calculated âœ“</div>)}
      </div>
    );
  }

  function ResultsPanel({ unit, results, category, tolerance }){
    const entries = Object.entries(results);
    if(entries.length===0) return <div className="text-slate-500">No brands selected.</div>;
    const keys = category==='Tops' ? ['chest','waist','hips'] : ['waist','hips','inseam'];

    return (
      <ul className="space-y-3">
        {entries.map(([brand, data])=>{
          const row = data.pick;
let badge;
if (data.reason === 'strict_in_range') {
  badge = <span className="ml-2 text-xs rounded-md px-2 py-0.5 border border-green-600 text-green-700">in range</span>;
} else if (data.reason === 'sized_up_to_fit') {
  badge = <span className="ml-2 text-xs rounded-md px-2 py-0.5 border border-blue-600 text-blue-700">sized up to fit</span>;
} else { // 'over_max'
  badge = <span className="ml-2 text-xs rounded-md px-2 py-0.5 border border-rose-600 text-rose-700">over max</span>;
}

          return (
            <li key={brand} className="rounded-xl border p-4">
              <div className="flex items-center justify-between gap-4">
                <div>
                  <div className="text-base font-medium">{brand}</div>
                  <div className="text-sm text-slate-600">{category}</div>
                </div>
                <div className="text-2xl font-semibold flex items-center">{row.label}{badge}</div>
              </div>

              <div className="mt-3 grid grid-cols-2 sm:grid-cols-4 gap-2 text-sm">
                {keys.map(k => {
                  if(!row[k]) return null;
                  const label = k[0].toUpperCase() + k.slice(1);
                  const delta = data.diag[k] ?? 0;
                  const deltaText = prettyDelta(delta, unit);
                  return (
                    <div key={k} className="rounded-lg bg-slate-50 border p-2">
                      <div className="text-slate-500">{label} range</div>
                      <div className="font-medium">{prettyRange(row[k], unit)}</div>
                      <div className={"mt-1 text-xs " + (delta===0 ? "text-green-700" : "text-amber-700")}>{deltaText}{delta===0 ? "" : " (outside by " + (unit==='in' ? Math.round(cmToIn(delta)*10)/10 : delta) + " " + unit + ")"}</div>
                    </div>
                  );
                })}
              </div>
            </li>
          );
        })}
      </ul>
    );
  }

  // pulse animation for button
  const style = document.createElement('style'); style.textContent = ".pulse{animation:pulseAnim .5s ease}@keyframes pulseAnim{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}"; document.head.appendChild(style);

  const root = ReactDOM.createRoot(document.getElementById('root'));
  root.render(<App />);
</script>
  </body>
</html>
